<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kick TTS</title>
  </head>
  <body>
    <div id="video"></div>
    <script>
      const defaultClusterID = "32cbd69e4b950bf97679";
      const defaultVersion = "8.4.0-rc2";
      const defaultRefreshToken = "refreshTTS";
      const defaultTtsVoice = "Brian";

      let currentVolume = 1.0;
      let currentAudio = null;
      let currentSpeed = 1.0;

      const ttsQueue = [];

      function enqueMessage(text, { voice = defaultTtsVoice }) {
        ttsQueue.push({ text, voice });

        if (ttsQueue.length == 1) {
          fetchAndPlayTTS();
        }
      }

      async function fetchAndPlayTTS() {
        if (ttsQueue.length == 0) {
          return;
        }

        // peek at the first message in the queue
        const { voice, text } = ttsQueue[0];

        try {
          const ttsUrl = `https://api.streamelements.com/kappa/v2/speech?voice=${voice}&text=${encodeURIComponent(
            text,
          )}`;

          // Fetch the audio response from the API
          const response = await fetch(ttsUrl);

          // Convert the response into a Blob and create an audio object
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);

          currentAudio = new Audio(audioUrl);

          currentAudio.volume = currentVolume;
          currentAudio.playbackRate = currentSpeed;

          currentAudio.onended = function () {
            // deque the first messages in the queue
            ttsQueue.shift();

            currentAudio = null;

            // yield back to the queue
            fetchAndPlayTTS();
          };

          // Play the audio
          currentAudio.play();
        } catch (error) {
          console.error("Error fetching TTS:", error);
        }
      }

      function playVideo(videoURL) {
        const vidContainer = document.getElementById("video");
        const iframe = document.createElement("iframe");

        iframe.width = "560";
        iframe.height = "315";
        iframe.src = videoURL;
        iframe.title = "video player";
        iframe.frameBorder = "0";
        iframe.allow =
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
        iframe.allowFullscreen = true;

        vidContainer.appendChild(iframe);
      }

      function clearVideos() {
        document.getElementById("video").innerHTML = "";
      }

      function connectToChatroom(
        roomId,
        {
          clusterID = defaultClusterID,
          version = defaultVersion,
          ttsVoice = defaultTtsVoice,
          refreshToken = defaultRefreshToken,
          admins = [],
        },
      ) {
        const ws = new WebSocket(
          `wss://ws-us2.pusher.com/app/${clusterID}?protocol=7&client=js&version=${version}&flash=false`,
        );

        ws.onopen = () => {
          console.log("Connected to WebSocket");

          const subscribeMessage = {
            event: "pusher:subscribe",
            data: {
              channel: `chatrooms.${roomId}.v2`,
              auth: "",
            },
          };
          ws.send(JSON.stringify(subscribeMessage));
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);

            // Check if the message is a chat message event
            if (message.event === "App\\Events\\ChatMessageEvent") {
              const chatMessage = JSON.parse(message.data);

              const senderUsername = chatMessage?.sender?.slug;

              const isAdmin = admins.includes(senderUsername);

              console.log("Received chat message:", chatMessage.content);

              // trigger an app refresh
              if (isAdmin && chatMessage.content === refreshToken) {
                location.reload();
              }

              if (isAdmin && chatMessage.content == "!skip") {
                // pause audio
                currentAudio.pause();

                // Set current time to end
                currentAudio.currentTime = currentAudio.duration;

                // trigger ended
                currentAudio.dispatchEvent(new Event("ended"));

                return;
              }

              // Use speech synthesis to read the message aloud
              if (chatMessage.content.startsWith("!s ")) {
                const voiceTokenRegex = /^!s\s*(\w+):/;
                const tokenVoiceMatch =
                  chatMessage.content.match(voiceTokenRegex);
                const voiceToken = tokenVoiceMatch
                  ? tokenVoiceMatch[1]
                  : undefined;

                const voice = voiceToken
                  ? voiceToken[0].toUpperCase() +
                    voiceToken.slice(1).toLowerCase()
                  : undefined;

                const cleanedString = chatMessage.content
                  .replace(voiceTokenRegex, "") // remove voice tokens
                  .replace(/^!s\s*/, "") // Removes "!s" prefix if present
                  .replace(/\[emote:[^\]]+:[^\]]+\]/g, ""); // Removes [emote:*:*] patterns

                enqueMessage(cleanedString, { voice: voice ?? ttsVoice });
              }

              // update Volume
              if (isAdmin && chatMessage.content.startsWith("!v ")) {
                const volVal = Number(parseFloat(chatMessage.content.slice(3)));

                if (!Number.isNaN(volVal) && volVal >= 0 && volVal <= 1) {
                  currentVolume = volVal;
                }
              }

              // streamable
              if (isAdmin && chatMessage.content.startsWith("!st")) {
                if (chatMessage.content.slice(4) == "clear") {
                  clearVideos();
                  return;
                }

                const streamableRegex =
                  /(?:https?:\/\/)?streamable\.com\/([a-zA-Z0-9]+)/;

                const streamableMatch =
                  chatMessage.content.match(streamableRegex);

                const streamableId = streamableMatch
                  ? streamableMatch[1]
                  : undefined;

                if (streamableId) {
                  const streamableURL = `https://streamable.com/e/${streamableId}?autoplay=1&loop=0`;
                  playVideo(streamableURL);
                }
              }

              // youtube
              if (isAdmin && chatMessage.content.startsWith("!yt")) {
                // clear all videos
                if (chatMessage.content.slice(4) == "clear") {
                  clearVideos();
                  return;
                }

                const youtubeRegex =
                  /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/;
                const youtubeMatch = chatMessage.content.match(youtubeRegex);

                const youtubeId = youtubeMatch ? youtubeMatch[1] : undefined;

                if (youtubeId) {
                  let youtubeURL = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;

                  playVideo(youtubeURL);
                }
              }

              // config management
              if (isAdmin && chatMessage.content.startsWith("!config ")) {
                const tokens = chatMessage.content.slice(8).split(" ");

                if (tokens.length < 2) {
                  return;
                }

                const [key, value] = tokens;

                if (key === "removeadmin" || key === "addadmin") {
                  const user = tokens[2];

                  if (key === "removeadmin") {
                    const i = admins.indexOf(value);

                    if (i >= 0) {
                      admins.splice(i, 1);
                    }
                  } else {
                    // addadmin

                    admins.push(value);
                  }

                  document.dispatchEvent(
                    new CustomEvent("reconnect-chat", {
                      detail: {
                        roomID,
                        clusterID,
                        ttsVoice,
                        refreshToken,
                        admins,
                      },
                    }),
                  );
                } else {
                  const [key, value] = tokens;

                  // close current connection
                  ws.close();

                  // dispatch reconnect-chat event
                  document.dispatchEvent(
                    new CustomEvent("reconnect-chat", {
                      detail: {
                        roomID,
                        clusterID,
                        ttsVoice,
                        refreshToken,
                        admins,
                        // replace option
                        [key]: value,
                      },
                    }),
                  );
                }
              }
            }

            if (message.event === "pusher:error") {
              console.error(
                "Received Error Message: ",
                JSON.parse(message.data),
              );
            }
          } catch (error) {
            console.error("Error parsing message:", error);
          }
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
        };

        ws.onclose = () => {
          console.log("WebSocket connection closed");
        };
      }

      // reconnect event handler

      document.addEventListener(
        "reconnect-chat",
        ({ detail: { roomID, clusterID, ttsVoice, refreshToken, admins } }) => {
          connectToChatroom(roomID, {
            clusterID,
            ttsVoice,
            refreshToken,
            admins,
          });
        },
      );

      // Get parameters from URL (roomId, clusterID, version)
      const urlParams = new URLSearchParams(window.location.search);
      const roomID = urlParams.get("roomId");
      const clusterID = urlParams.get("clusterID") ?? defaultClusterID;
      const version = urlParams.get("version") ?? defaultVersion;
      const refreshToken = urlParams.get("refreshToken") ?? defaultRefreshToken;
      const ttsVoice = urlParams.get("ttsVoice") ?? defaultTtsVoice;

      currentSpeed = parseFloat(urlParams.get("ttsSpeed")) ?? 1.0;

      const admins =
        urlParams
          .get("admins")
          ?.split(",")
          .map((admin) => admin.toLowerCase()) ?? [];

      if (!roomID) {
        console.error("Missing room Id");
      } else {
        connectToChatroom(roomID, {
          clusterID,
          version,
          refreshToken,
          ttsVoice,
          admins,
        });
      }
    </script>
  </body>
</html>
